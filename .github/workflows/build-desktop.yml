name: æ„å»ºå¹¶å‘å¸ƒæ¡Œé¢åº”ç”¨

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v0.1.0)'
        required: true
        default: 'v0.1.0'
  # æ³¨æ„ï¼šæ­¤å·¥ä½œæµä»…åœ¨æ‰“ tag æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œï¼Œä¸ä¼šåœ¨æ¯æ¬¡ push æ—¶è¿è¡Œ

permissions:
  contents: write
  packages: write

jobs:
  # æ£€æŸ¥å¹¶æ„å»ºå‰ç«¯
  build-frontend:
    name: æ£€æŸ¥å¹¶æ„å»ºå‰ç«¯
    runs-on: ubuntu-latest
    outputs:
      has-frontend-source: ${{ steps.check-frontend.outputs.has-source }}
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: æ£€æŸ¥å‰ç«¯æºä»£ç 
      id: check-frontend
      run: |
        if [ -f "frontend/package.json" ] && [ -d "frontend/src" ]; then
          echo "has-source=true" >> $GITHUB_OUTPUT
          echo "âœ“ æ£€æµ‹åˆ°å‰ç«¯æºä»£ç "
        else
          echo "has-source=false" >> $GITHUB_OUTPUT
          echo "âœ“ ä½¿ç”¨å·²ç¼–è¯‘çš„å‰ç«¯ä»£ç "
        fi
    
    - name: è®¾ç½® Node.js
      if: steps.check-frontend.outputs.has-source == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: å®‰è£…å‰ç«¯ä¾èµ–
      if: steps.check-frontend.outputs.has-source == 'true'
      working-directory: frontend
      run: npm ci
    
    - name: æ„å»ºå‰ç«¯
      if: steps.check-frontend.outputs.has-source == 'true'
      working-directory: frontend
      run: npm run build
    
    - name: ä¸Šä¼ å‰ç«¯æ„å»ºäº§ç‰©
      if: steps.check-frontend.outputs.has-source == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist/
        retention-days: 1

  # æ„å»ºå¤šå¹³å°æ¡Œé¢åº”ç”¨
  build-desktop:
    name: æ„å»º ${{ matrix.platform }} ç‰ˆæœ¬
    needs: build-frontend
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: Linux
            artifact-name: CountBot-Linux-x64
          - os: windows-latest
            platform: Windows
            artifact-name: CountBot-Windows-x64
          - os: macos-latest
            platform: macOS
            artifact-name: CountBot-macOS-x64
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ä¸‹è½½å‰ç«¯æ„å»ºäº§ç‰©
      if: needs.build-frontend.outputs.has-frontend-source == 'true'
      uses: actions/download-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist/
    
    - name: éªŒè¯å‰ç«¯æ–‡ä»¶
      run: |
        if [ -d "frontend/dist" ]; then
          echo "âœ“ å‰ç«¯æ–‡ä»¶å­˜åœ¨"
          ls -la frontend/dist/
        else
          echo "âœ— å‰ç«¯æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
      shell: bash
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: è®¾ç½®å›¾æ ‡è·¯å¾„
      id: icon
      shell: bash
      run: |
        if [ "$RUNNER_OS" == "macOS" ]; then
          echo "path=resources/countbot.icns" >> $GITHUB_OUTPUT
        elif [ "$RUNNER_OS" == "Windows" ]; then
          echo "path=resources/countbot.ico" >> $GITHUB_OUTPUT
        else
          echo "path=resources/countbot.png" >> $GITHUB_OUTPUT
        fi

    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        pyinstaller --clean --noconfirm \
          --name=CountBot \
          --onedir  \
          --windowed \
          --icon="${{ steps.icon.outputs.path }}" \
          --add-data="frontend/dist:frontend/dist" \
          --add-data="skills:skills" \
          --add-data="memory:memory" \
          --add-data="resources:resources" \
          --collect-data litellm \
          --collect-data dateparser \
          --collect-data tiktoken_ext \
          --collect-data croniter \
          --collect-data trafilatura \
          --collect-data lxml \
          --hidden-import=tiktoken_ext.openai_public \
          --hidden-import=tiktoken_ext \
          --hidden-import=greenlet \
          --hidden-import=greenlet._greenlet \
          --hidden-import=backend \
          --hidden-import=backend.app \
          --hidden-import=backend.database \
          --hidden-import=backend.utils.paths \
          --hidden-import=backend.utils.logger \
          --hidden-import=backend.api.auth \
          --hidden-import=backend.api.chat \
          --hidden-import=backend.api.channels \
          --hidden-import=backend.api.settings \
          --hidden-import=backend.api.tools \
          --hidden-import=backend.api.skills \
          --hidden-import=backend.api.memory \
          --hidden-import=backend.api.tasks \
          --hidden-import=backend.api.system \
          --hidden-import=backend.api.audio \
          --hidden-import=backend.api.queue \
          --hidden-import=backend.api.cron \
          --hidden-import=backend.api.personalities \
          --hidden-import=backend.models.message \
          --hidden-import=backend.models.session \
          --hidden-import=backend.models.setting \
          --hidden-import=backend.models.task \
          --hidden-import=backend.models.cron_job \
          --hidden-import=backend.models.tool_conversation \
          --hidden-import=backend.models.personality \
          --hidden-import=uvicorn \
          --hidden-import=uvicorn.logging \
          --hidden-import=uvicorn.loops \
          --hidden-import=uvicorn.loops.auto \
          --hidden-import=uvicorn.protocols \
          --hidden-import=uvicorn.protocols.http \
          --hidden-import=uvicorn.protocols.http.auto \
          --hidden-import=uvicorn.protocols.websockets \
          --hidden-import=uvicorn.protocols.websockets.auto \
          --hidden-import=uvicorn.lifespan \
          --hidden-import=uvicorn.lifespan.on \
          --hidden-import=fastapi \
          --hidden-import=sqlalchemy.ext.asyncio \
          --hidden-import=aiosqlite \
          --exclude-module=playwright \
          --exclude-module=pandas \
          --exclude-module=numpy \
          --exclude-module=PyQt5 \
          --exclude-module=PyQt6 \
          --exclude-module=PySide2 \
          --exclude-module=PySide6 \
          --exclude-module=tkinter \
          --exclude-module=matplotlib \
          --exclude-module=scipy \
          --exclude-module=PIL.ImageQt \
          --exclude-module=transformers \
          --exclude-module=torch \
          --exclude-module=tensorflow \
          --exclude-module=psycopg2 \
          --exclude-module=asyncpg \
          start_desktop.py
    
    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ (Windows)
      if: runner.os == 'Windows'
      run: |
        pyinstaller --clean --noconfirm `
          --name=CountBot `
          --onedir `
          --windowed `
          --icon="${{ steps.icon.outputs.path }}" `
          --add-data="frontend/dist;frontend/dist" `
          --add-data="skills;skills" `
          --add-data="memory;memory" `
          --add-data="resources;resources" `
          --collect-data litellm `
          --collect-data dateparser `
          --collect-data tiktoken_ext `
          --collect-data croniter `
          --collect-data trafilatura `
          --collect-data lxml `
          --hidden-import=tiktoken_ext.openai_public `
          --hidden-import=tiktoken_ext `
          --hidden-import=greenlet `
          --hidden-import=greenlet._greenlet `
          --hidden-import=backend `
          --hidden-import=backend.app `
          --hidden-import=backend.database `
          --hidden-import=backend.utils.paths `
          --hidden-import=backend.utils.logger `
          --hidden-import=backend.api.auth `
          --hidden-import=backend.api.chat `
          --hidden-import=backend.api.channels `
          --hidden-import=backend.api.settings `
          --hidden-import=backend.api.tools `
          --hidden-import=backend.api.skills `
          --hidden-import=backend.api.memory `
          --hidden-import=backend.api.tasks `
          --hidden-import=backend.api.system `
          --hidden-import=backend.api.audio `
          --hidden-import=backend.api.queue `
          --hidden-import=backend.api.cron `
          --hidden-import=backend.api.personalities `
          --hidden-import=backend.models.message `
          --hidden-import=backend.models.session `
          --hidden-import=backend.models.setting `
          --hidden-import=backend.models.task `
          --hidden-import=backend.models.cron_job `
          --hidden-import=backend.models.tool_conversation `
          --hidden-import=backend.models.personality `
          --hidden-import=uvicorn `
          --hidden-import=uvicorn.logging `
          --hidden-import=uvicorn.loops `
          --hidden-import=uvicorn.loops.auto `
          --hidden-import=uvicorn.protocols `
          --hidden-import=uvicorn.protocols.http `
          --hidden-import=uvicorn.protocols.http.auto `
          --hidden-import=uvicorn.protocols.websockets `
          --hidden-import=uvicorn.protocols.websockets.auto `
          --hidden-import=uvicorn.lifespan `
          --hidden-import=uvicorn.lifespan.on `
          --hidden-import=fastapi `
          --hidden-import=sqlalchemy.ext.asyncio `
          --hidden-import=aiosqlite `
          --hidden-import=webview `
          --hidden-import=webview.platforms.edgechromium `
          --hidden-import=webview.platforms.winforms `
          --exclude-module=playwright `
          --exclude-module=pandas `
          --exclude-module=numpy `
          --exclude-module=PyQt5 `
          --exclude-module=PyQt6 `
          --exclude-module=PySide2 `
          --exclude-module=PySide6 `
          --exclude-module=tkinter `
          --exclude-module=matplotlib `
          --exclude-module=scipy `
          --exclude-module=PIL.ImageQt `
          --exclude-module=transformers `
          --exclude-module=torch `
          --exclude-module=tensorflow `
          --exclude-module=psycopg2 `
          --exclude-module=asyncpg `
          start_desktop.py
    
    - name: æ‰“åŒ…å‘å¸ƒæ–‡ä»¶ (macOS)
      if: runner.os == 'macOS'
      run: |
        cd dist
        tar -czf ${{ matrix.artifact-name }}.tar.gz CountBot.app/
        ls -lh *.tar.gz
    
    - name: æ‰“åŒ…å‘å¸ƒæ–‡ä»¶ (Linux)
      if: runner.os == 'Linux'
      run: |
        cd dist
        tar -czf ${{ matrix.artifact-name }}.tar.gz CountBot/
        ls -lh *.tar.gz
    
    - name: æ‰“åŒ…å‘å¸ƒæ–‡ä»¶ (Windows)
      if: runner.os == 'Windows'
      run: |
        cd dist
        Compress-Archive -Path CountBot -DestinationPath ${{ matrix.artifact-name }}.zip
        Get-ChildItem *.zip
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: |
          dist/*.tar.gz
          dist/*.zip
        retention-days: 7

  # åˆ›å»º GitHub Release
  create-release:
    name: åˆ›å»º GitHub Release
    needs: build-desktop
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½®ç‰ˆæœ¬å·
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "is_manual=true" >> $GITHUB_OUTPUT
        else
          echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "is_manual=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: æ˜¾ç¤ºæ„å»ºäº§ç‰©
      run: |
        echo "æ„å»ºäº§ç‰©åˆ—è¡¨ï¼š"
        find artifacts -type f
        echo ""
        echo "æ–‡ä»¶è¯¦æƒ…ï¼š"
        find artifacts -type f -exec ls -lh {} \;
    
    - name: åˆ›å»º Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: CountBot ${{ steps.version.outputs.version }}
        files: |
          artifacts/*/*.tar.gz
          artifacts/*/*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## CountBot ${{ steps.version.outputs.version }}
          
          ### âš ï¸ é‡è¦æç¤º
          
          **æ¡Œé¢ç‰ˆç›®å‰å¤„äºæµ‹è¯•é˜¶æ®µï¼Œå¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ã€‚**
          
          å¦‚æœæ‚¨åœ¨ä½¿ç”¨æ¡Œé¢ç‰ˆæ—¶é‡åˆ°é—®é¢˜ï¼Œæˆ‘ä»¬å¼ºçƒˆå»ºè®®ï¼š
          
          1. **ä½¿ç”¨ Python æºç è¿è¡Œ**ï¼ˆæ¨èï¼‰ï¼š
             ```bash
             git clone https://github.com/countbot-ai/CountBot.git
             cd CountBot
             pip install -r requirements.txt
             python start_desktop.py
             ```
          
          2. **åé¦ˆé—®é¢˜å¸®åŠ©æˆ‘ä»¬æ”¹è¿›**ï¼š
             - é‡åˆ°é”™è¯¯è¯·åœ¨ [Issues](https://github.com/countbot-ai/CountBot/issues) åé¦ˆ
             - æä¾›é”™è¯¯ä¿¡æ¯ã€ç³»ç»Ÿç‰ˆæœ¬ç­‰è¯¦ç»†ä¿¡æ¯
             - æ‚¨çš„åé¦ˆå°†å¸®åŠ©æˆ‘ä»¬å®Œå–„æ¡Œé¢ç‰ˆï¼Œé™ä½ AI Agent çš„ä½¿ç”¨é—¨æ§›
          
          ---
          
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          
          #### Windows
          ```cmd
          # 1. è§£å‹ zip æ–‡ä»¶
          # 2. åŒå‡»è¿è¡Œ CountBot.exe
          # 3. å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ä½¿ç”¨ Python æºç è¿è¡Œ
          ```
          
          **å¸¸è§é—®é¢˜ï¼š**
          - ç¼ºå°‘ Edge WebView2ï¼š[ä¸‹è½½å®‰è£…](https://go.microsoft.com/fwlink/p/?LinkId=2124703)
          - ç«¯å£è¢«å ç”¨ï¼šä¿®æ”¹é»˜è®¤çš„8000é”»ç‚¼
          - é˜²ç«å¢™æ‹¦æˆªï¼šå…è®¸ CountBot è®¿é—®ç½‘ç»œ
          
          #### macOS
          ```bash
          # è§£å‹
          tar -xzf CountBot-macOS-x64.tar.gz
          
          # æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x CountBot/CountBot
          
          # è¿è¡Œ
          ./CountBot/CountBot
          ```
          
          **å¸¸è§é—®é¢˜ï¼š**
          - "æ— æ³•æ‰“å¼€ï¼Œå› ä¸ºæ— æ³•éªŒè¯å¼€å‘è€…"ï¼š
            ```bash
            xattr -cr CountBot/CountBot
            ```
          - ç³»ç»Ÿç‰ˆæœ¬è¦æ±‚ï¼šmacOS 10.13 æˆ–æ›´é«˜
          
          #### Linux
          ```bash
          # è§£å‹
          tar -xzf CountBot-Linux-x64.tar.gz
          
          # æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x CountBot/CountBot
          
          # è¿è¡Œ
          ./CountBot/CountBot
          ```
          
          **å¸¸è§é—®é¢˜ï¼š**
          - ç¼ºå°‘ WebKit2GTKï¼š
            ```bash
            # Ubuntu/Debian
            sudo apt install webkit2gtk-4.0
            
            # Fedora
            sudo dnf install webkit2gtk3
            ```
          
          ---
          
          ### ğŸ› é‡åˆ°é—®é¢˜ï¼Ÿ
          
          1. **æŸ¥çœ‹æ—¥å¿—**ï¼š`data/logs/CountBot_*.log`
          2. **æäº¤ Issue**ï¼š[GitHub Issues](https://github.com/countbot-ai/CountBot/issues)
          3. **ä½¿ç”¨æºç è¿è¡Œ**ï¼šæ›´ç¨³å®šï¼Œæ›´å®¹æ˜“è°ƒè¯•
          
          ### ğŸ’¡ ä¸ºä»€ä¹ˆæ¨èæºç è¿è¡Œï¼Ÿ
          
          - âœ… å…¼å®¹æ€§æ›´å¥½ï¼Œé¿å…æ‰“åŒ…é—®é¢˜
          - âœ… é”™è¯¯ä¿¡æ¯æ›´è¯¦ç»†ï¼Œä¾¿äºæ’æŸ¥
          - âœ… å¯ä»¥éšæ—¶æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
          - âœ… æ”¯æŒæ‰€æœ‰ Python ç¯å¢ƒå’Œä¾èµ–
          
          ---
          
          ### ğŸ“ æ›´æ–°æ—¥å¿—
          
          è¯¦è§ä¸‹æ–¹è‡ªåŠ¨ç”Ÿæˆçš„æ›´æ–°è¯´æ˜ã€‚
          
          ---
          
          ### ğŸ™ æ„Ÿè°¢æ‚¨çš„æ”¯æŒ
          
          CountBot è‡´åŠ›äºé™ä½ AI Agent çš„ä½¿ç”¨é—¨æ§›ã€‚æ‚¨çš„åé¦ˆå’Œå»ºè®®å¯¹æˆ‘ä»¬è‡³å…³é‡è¦ï¼
          
          - â­ å¦‚æœè§‰å¾—æœ‰ç”¨ï¼Œè¯·ç»™æˆ‘ä»¬ä¸€ä¸ª Star
          - ğŸ› é‡åˆ°é—®é¢˜ï¼Œè¯·æäº¤ Issue
          - ğŸ’¬ æœ‰æƒ³æ³•ï¼Œæ¬¢è¿å‚ä¸è®¨è®º
          - ğŸ¤ æƒ³è´¡çŒ®ï¼ŒæŸ¥çœ‹ [CONTRIBUTING.md](https://github.com/countbot-ai/CountBot/blob/main/CONTRIBUTING.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
